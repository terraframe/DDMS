<?xml version="1.0" encoding="UTF-8" ?>

<project name="MDSS" default="all" basedir=".">

<target name="all" depends="clean, build, test "/>

<taskdef resource="org/tigris/subversion/svnant/svnantlib.xml" classpath="lib/ant/svnant.jar;lib/ant/svnClientAdapter.jar;lib/ant/svnkit.jar;lib/ant/svnjavahl.jar;lib/ant/ganymed.jar;"/>
  <property name="country" value="zambia"/>
  <property name="geodata.db" value="mrc_${country}"/>
  <property name="deploy.db" value="mdssdeploy"/>
  <property name="develop.db" value="mdssdevelop"/>
  <property name="nsis.dir" location="C:/Program Files/NSIS"/>
  <property name="postgres.bin" location="C:/Program Files/PostgreSQL/8.4/bin"/>
  <property name="profile.root" location="profiles"/>
  <property name="stage.dir" location="C:/stage"/>
  <property name="artifacts.path" location="C:/stage/tomcat6"/>
  <property name="stage.classes" location="${artifacts.path}/webapps/MDSS/WEB-INF/classes"/>
  <property name="root.user" value="postgres"/>
  <property name="root.pass" value="postgres"/>
  <property name="root.db" value="template_postgis"/>
  <property name="max_memory_use" value="1024m"/>
  <property name="domain" value="mdss.ivcc.com"/>
  <property name="local.root" location="."/>
  <property name="deploy.root" location="C:/stage/tomcat6"/>

  <target name="build">
    <ant inheritall="false" antfile="deploy.xml" dir="scripts/ant/deploy">
      <property name="root.user" value="${root.user}"/>
      <property name="root.pass" value="${root.pass}"/>
      <property name="root.db" value="${root.db}"/>
      <property name="geodata.db" value="${geodata.db}"/>
      <property name="profile.root" value="${profile.root}"/>

      <target name="rebuild_db"/>
      <target name="rebuild_model"/>
      <target name="compile_generated_src"/>
      
      <target name="import_ontology"/>
      <target name="import_ontology_roots"/>
      <target name="build_all_paths_ontology"/>
      <target name="build_all_paths_geodata"/>
      <target name="create_universal_queries"/>
     
    </ant>
  </target>
  
  <target name="clean">
    <propertyfile file="${profile.root}/default/common/terraframe.properties">
      <entry key="local.root" value="${local.root}"/>
      <entry key="deploy.root" value="${deploy.root}"/>
      <entry key="domain" value="${domain}"/>
    </propertyfile>
    <propertyfile file="${profile.root}/default/server/server.properties">
      <entry key="logTransactions" value="false"/>
    </propertyfile>
    <replaceregexp flags="g" byline="true" file="${profile.root}/default/common/terraframe.properties" match="\\\\" replace="/"/>
    <replaceregexp flags="g" byline="true" file="${profile.root}/default/common/terraframe.properties" match="\\\:" replace=":"/>
    <antcall target="remove_generated_universals"/>
    <antcall target="copy_country_schema"/>

    <delete dir="scripts/ant/deploy/target"/>
    <delete dir="scripts/ant/deploy/test-results"/>

    <!-- 
    <delete includeemptydirs="true">
      <fileset dir="bin" includes="**/*"/>
    </delete>
    -->

  </target>

  <target name="test" >
   <ant inheritall="false" antfile="deploy.xml" dir="scripts/ant/deploy">
      <property name="root.user" value="${root.user}"/>
      <property name="root.pass" value="${root.pass}"/>
      <property name="root.db" value="${root.db}"/>
      <property name="geodata.db" value="${geodata.db}"/>
      <property name="profile.root" value="${profile.root}"/>

      <target name="test"/>

    </ant>
  </target>
  
  <target name="remove_generated_universals" depends="" description="Remove all java files for selected (old) generated universals">
    <patternset id="generated.artifacts">
      <include name="**/*"/>
      <exclude name="Earth*"/>
      <exclude name="GeoEntity*"/>
      <exclude name=".svn*"/>
    </patternset>
    <delete failonerror="false">
      <fileset dir="generated/client/stub/dss/vector/solutions/geo/generated/">
        <patternset refid="generated.artifacts"/>
      </fileset>
    </delete>
    <delete failonerror="false">
      <fileset dir="generated/client/base/dss/vector/solutions/geo/generated/">
        <patternset refid="generated.artifacts"/>
      </fileset>
    </delete>
    <delete failonerror="false">
      <fileset dir="generated/server/stub/dss/vector/solutions/geo/generated/">
        <patternset refid="generated.artifacts"/>
      </fileset>
    </delete>
    <delete failonerror="false">
      <fileset dir="generated/server/base/dss/vector/solutions/geo/generated/">
        <patternset refid="generated.artifacts"/>
      </fileset>
    </delete>
    <delete includeemptydirs="true" failonerror="false">
      <fileset dir="webapp/WEB-INF/dss/vector/solutions/geo/generated" defaultexcludes="false">
        <patternset refid="generated.artifacts"/>
      </fileset>
    </delete>
  </target>
  
  <target name="copy_country_schema" depends="" description="Copy the appropriate country schema file">
    <echo message="Switching to country: ${geodata.db}"/>
    <copy file="doc/country/${geodata.db}-schema(0001238646707001).xml" tofile="doc/individual/schema(0001238646707001).xml" overwrite="true"/>
    <copy file="webapp/imgs/flags/${geodata.db}.gif" tofile="webapp/imgs/flags/current" overwrite="true"/>
  </target>
  <target name="svn_update" description="Writes the current svn revision info to an html file">
    <svn>
      <update target="." verbose="true"/>
    </svn>
  </target>



	<target name="compile_generated_src">
		<iajc destdir="${local.bin}"  debug="true" source="1.5" target="1.5" aspectpath="${local.lib}/runwaysdk.jar"  maxmem="1024m" verbose="false">
			<classpath>
				<path refid="framework.classpath" />
				<pathelement location="${common.bin}" />
			</classpath>
			 <sourceroots>
				 <pathelement location="${local.src}/client"/>
				 <pathelement location="${local.src}/common"/>
				 <pathelement location="${local.src}/server"/>
        <pathelement location="${common.src}"/>
        <pathelement location="${client.src}"/>
        <pathelement location="${server.src}"/>
      </sourceroots>
		</iajc>
	</target>


	<target name="test" >

	<iajc destdir="target/test-classes"  debug="true" source="1.5" target="1.5" aspectpath="${local.lib}/runwaysdk.jar"  maxmem="1024m" verbose="false">
		<classpath>
		<path refid="framework.classpath" />
		<pathelement location="${common.bin}" />
		</classpath>
		 <sourceroots>
		 <pathelement location="${local.src}/test"/>
	      </sourceroots>
	</iajc> 

    <mkdir dir="target/test-classes"/>
    <mkdir dir="test-results"/>
    <junit haltonfailure="no" printsummary="on">
	    <classpath>
		    <pathelement location="target/test-classes"/>
		    <pathelement location="${common.bin}" />
		    <path refid="framework.classpath" />
       </classpath>
      <formatter type="brief" usefile="false"/>
      <formatter type="xml"/>
      <batchtest todir="test-results">
	      <fileset dir="target/test-classes" includes="**/*Test.class"/>
      </batchtest>
    </junit>
  </target>


</project>


	<!--
		Delegating build script, used by cruisecontrol to build MY_PROJECT_1.
		Note that the basedir is set to the checked out project
		
		
		<parameter value = "mdss_zambia" name = "user" />
        <parameter value = "mdss_zambia" name = "passwd" />
        <parameter value = "mdss_zambia" name = "database" />
	-->

<project name="MDSS" default="build" basedir="scripts/ant/deploy">
	<property name="country" value="malawi" />
	<property name="country_uppercase" value="Malawi" />
	
	<property name="geodata.db" value="mrc_${country}" />
	<property name="deploy.db" value="mdss_${country}" />
	<property name="postgres.bin" location="C:/MDSS/PostgreSQL/8.4/bin" />
	<property name="local.root" location="C:/BUILD/projects/MDSS" />
	<property name="deploy.root" location="C:/BUILD/artifacts/tomcat6" />
	<property name="profile.root" location="C:/Build/projects/MDSS/profiles" />

	<property name="artifacts.path" location="C:/BUILD/artifacts/tomcat6" />
	<property name="installer.path" location="C:/MDSS/${country}/" />
	<property name="installer.deploy_root" value="C:/MDSS/${country}/" />

	<property name="develop.db" value="mdssdevelop" />

	<property name="root.user" value="postgres" />
	<property name="root.pass" value="postgres" />
	<property name="root.db" value="template_postgis" />
	<property name="max_memory_use" value="1024m" />

	<target name="build">
		<!-- Get the latest from CVS 
        <cvs command="up -d -P"/>  -->
		<!--Call the target that does everything-->		
		
		<delete dir="${artifacts.path}/webapps/MDSS" />
			
		<ant inheritall="false" antfile="build.xml">
			<property name="root.user" value="${root.user}" />
			<property name="root.pass" value="${root.pass}" />
			<property name="root.db" value="${root.db}" />
			<property name="geodata.db" value="${geodata.db}" />
			<target name="remove_generated_universals" />
			<target name="copy_country_schema" />
		</ant>
		<java classname="org.apache.tools.ant.launch.Launcher" fork="true"
			failonerror="true" dir="." timeout="4000000" taskname="Develop
			Rebuild All">
			<jvmarg value="-Xmx${max_memory_use}" />
			<jvmarg value="-Dmojo.keepSource=true" />
			<classpath>
				<pathelement location="${ant.home}/lib/ant-launcher.jar" />
			</classpath>
			<arg value="-buildfile" />
			<arg file="deploy.xml" />
			<arg value="-Droot.user=${root.user}" />
			<arg value="-Droot.pass=${root.pass}" />
			<arg value="-Droot.db=${root.db}" />
			<arg value="-Dgeodata.db=${geodata.db}" />
			<arg value="rebuild_db" />
			<arg value="delete_generated_base" />
			<arg value="import_most_recent" />
		</java>
		<ant inheritall="false" antfile="deploy.xml">
			<property name="root.user" value="${root.user}" />
			<property name="root.pass" value="${root.pass}" />
			<property name="root.db" value="${root.db}" />
			<property name="geodata.db" value="${geodata.db}" />
			<target name="deploy" />
		</ant>
		<ant inheritall="false" antfile="deploy.xml">
			<property name="root.user" value="${root.user}" />
			<property name="root.pass" value="${root.pass}" />
			<property name="root.db" value="${root.db}" />
			<property name="geodata.db" value="${geodata.db}" />
			<target name="import_geodata" />
			<target name="build_all_paths_geodata" />
			<target name="import_ontology" />
			<target name="import_ontology_roots" />
			<target name="build_all_paths_ontology" />
		</ant>
		<antcall target="copy_dev_to_deploy" />

		<delete dir="${installer.path}" />
		<mkdir dir="${installer.path}" />
		<copy todir="${installer.path}">
			<fileset dir="${artifacts.path}">
				<include name="**/*" />
			</fileset>
		</copy>
		<copy file="dump.sql" tofile="${installer.path}/${country}.sql" />
		<delete file="./dump.sql" />
		
		<mkdir dir="${installer.path}/webapps/MDSS/WEB-INF/logs"/>
		
		<touch file="${installer.path}/webapps/MDSS/WEB-INF/logs/seriousErrorLog.txt"/>
		<touch file="${installer.path}/webapps/MDSS/WEB-INF/logs/errorLog.txt"/>

		<propertyfile file="${installer.path}/webapps/MDSS/WEB-INF/classes/database.properties">
			<entry key="user" value="${deploy.db}" />
			<entry key="password" value="${deploy.db}" />
			<entry key="databaseName" value="${deploy.db}" />
		</propertyfile>
		
		<replaceregexp byline="true" 
			file="${installer.path}/webapps/MDSS/WEB-INF/classes/terraframe.properties"
			match='^local.root=.*$' 
			replace="local.root=${installer.deploy_root}" />
			
		<replaceregexp byline="true" 
			file="${installer.path}/webapps/MDSS/WEB-INF/classes/terraframe.properties"
			match='^deploy.root=.*$' 
			replace="deploy.root=${installer.deploy_root}" />
		
		<propertyfile
			file="${installer.path}/webapps/MDSS/WEB-INF/classes/jawr.properties">
			<entry key="jawr.debug.on" value="false" />
		</propertyfile>
		
		<propertyfile file="${installer.path}/webapps/MDSS/WEB-INF/classes/MDSS.properties">
			<entry key="Country" value="${country_uppercase}" />
		</propertyfile>
	</target>

	<target name="copy_dev_to_deploy" depends=""
		description="Rebuild Develop from scratch and then copy everything to deploy.">
		<echo message="dumping the develop db to a sql file " />
		<exec executable="${postgres.bin}/pg_dump" dir="./" failonerror="true"
			searchpath="true" logError="true">
			<arg line="--blobs -h 127.0.0.1 -U ${root.user} ${develop.db}" />
			<redirector output="dump.sql">
				<outputfilterchain>
					<!--make sql dump stop on errors -->
					<concatfilter prepend="drop_deploy.sql" />
					<!--change 'mdssdevelop' to 'mdssdeploy' -->
					<tokenfilter>
						<replacestring from="${develop.db}" to="${deploy.db}" />
					</tokenfilter>
				</outputfilterchain>
			</redirector>
		</exec>

		<echo message="drop and recreate the deploy db" />
		<exec executable="${postgres.bin}/psql" dir="./" failonerror="true"
			searchpath="true" logError="true"
			inputstring="DROP DATABASE ${deploy.db};
			  CREATE DATABASE ${deploy.db} WITH ENCODING='UTF8' TEMPLATE=template0 OWNER=${deploy.db};">
			<arg line="-h 127.0.0.1 -U ${root.user} -d postgres" />
		</exec>

		<echo message="import the sql dump into the develop db" />
		<exec executable="${postgres.bin}/psql" dir="./" input="dump.sql"
			failonerror="true" searchpath="true" logError="true">
			<arg line="-h 127.0.0.1 -U ${root.user} -d ${deploy.db}" />
		</exec>
		<!--<delete file="./dump.sql" />-->
	</target>
</project>
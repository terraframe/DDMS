package dss.vector.solutions.util;

import java.awt.ComponentOrientation;
import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.Iterator;
import java.util.Locale;
import java.util.Map;
import java.util.Set;
import java.util.Map.Entry;

import org.json.JSONException;
import org.json.JSONObject;

import com.runwaysdk.business.rbac.Authenticate;
import com.runwaysdk.configuration.ProfileManager;
import com.runwaysdk.dataaccess.MdDimensionDAOIF;
import com.runwaysdk.dataaccess.ProgrammingErrorException;
import com.runwaysdk.dataaccess.io.FileWriteException;
import com.runwaysdk.dataaccess.metadata.MdDimensionDAO;
import com.runwaysdk.dataaccess.transaction.Transaction;
import com.runwaysdk.generation.loader.Reloadable;
import com.runwaysdk.query.OIterator;
import com.runwaysdk.query.QueryFactory;
import com.runwaysdk.session.Session;
import com.runwaysdk.system.metadata.SupportedLocale;
import com.runwaysdk.system.metadata.SupportedLocaleQuery;
import com.runwaysdk.util.FileIO;

import dss.vector.solutions.InstallProperties;
import dss.vector.solutions.localization.MultiBundle;

public abstract class LocalizationFacade extends LocalizationFacadeBase implements Reloadable
{
  private static final long serialVersionUID = 1002885644;
  
  public LocalizationFacade()
  { 
    super();
  }
  
  @Authenticate
  public static SupportedLocaleQuery getInstalledLocales()
  {
    SupportedLocaleQuery query = new SupportedLocaleQuery(new QueryFactory());
    query.ORDER_BY_ASC(query.getLocaleLabel());
    return query;
  }
  
  @Authenticate
  public static void installLocale(String localeString)
  {
    InstallProperties.validateMasterOperation();
    
    install(localeString);
    String message = "# Blank template generated by Runway";
    File dir = ProfileManager.getProfileRootDir();
    File propertyFile = new File(dir, "MDSS_" + localeString + ".properties");
    try
    {
      FileIO.write(propertyFile, message);
    }
    catch (IOException e)
    {
      throw new FileWriteException(propertyFile, e);
    }
    
    for (MdDimensionDAOIF dimension : MdDimensionDAO.getAllMdDimensions())
    {
      File dimensionPropertyFile = new File(dir, "MDSS-" + dimension.getName() + "_" + localeString + ".properties");
      try
      {
        FileIO.write(dimensionPropertyFile, message);
      }
      catch (IOException e)
      {
        throw new FileWriteException(dimensionPropertyFile, e);
      }
    }
  }

  @Transaction
  private static void install(String localeString)
  {
    Locale l = getLocaleFromString(localeString);
    String displayName = l.getDisplayName(Locale.ENGLISH);
    
    SupportedLocale sl = new SupportedLocale();
    sl.setEnumName(localeString);
    sl.setLocaleLabel(displayName);
    sl.getDisplayLabel().setDefaultValue(displayName);
    sl.apply();
  }
  
  public static Locale getLocaleFromString(String localeString)
  {
    String[] split = localeString.split("_", 3);
    if (split.length==1)
    {
      return new Locale(split[0]);
    }
    else if (split.length==2)
    {
      return new Locale(split[0], split[1]);
    }
    else
    {
      return new Locale(split[0], split[1], split[2]);
    }
  }
  
  @Authenticate
  public static InputStream exportFile(String[] locales)
  {
    MdssLocalizationExporter mdssLocalizer = new MdssLocalizationExporter();
    
    for (String s : locales)
    {
      mdssLocalizer.addLocale(getLocaleFromString(s));
    }
    
    mdssLocalizer.export();
    return new ByteArrayInputStream(mdssLocalizer.write());
  }
  
  @Authenticate
  public static void importFile(InputStream file)
  {
    MdssLocalizationImporter mli = new MdssLocalizationImporter();
    mli.read(file);
    MultiBundle.reload();
  }
  
  public static String getFromBundles(String key)
  {
    return MultiBundle.get(key);
  }
  
  @Authenticate
  public static OrientationType getSessionLocaleOrientation()
  {
    boolean isLTR = ComponentOrientation.getOrientation(Session.getCurrentLocale()).isLeftToRight();
    if (isLTR)
      return OrientationType.LTR;
    else
    {
      SupportedLocaleQuery installedLocales = getInstalledLocales();
      OIterator<? extends SupportedLocale> iterator = installedLocales.getIterator();
  
      while (iterator.hasNext())
      {
        SupportedLocale supportedLocale = (SupportedLocale) iterator.next();
        if (Session.getCurrentLocale().toString().equals(supportedLocale.getEnumName()))
          return OrientationType.RTL;
      }
      return OrientationType.LTR;
    }
  }
  
  public static String getSessionLocale()
  {
    return Session.getCurrentLocale().toString();
  }
  
  @Deprecated
  public static String getAllLocalizedText()
  {
    Map<String, String> all = MultiBundle.getAll();
    
    JSONObject json = new JSONObject(all);
    
    return json.toString();
  }
  
  public static String getJSON()
  {
    Map<String, String> properties = MultiBundle.getAll();

    try
    {
      JSONObject object = new JSONObject();
      
      Set<Entry<String, String>> entries = properties.entrySet();

      Iterator<Entry<String, String>> it = entries.iterator();

      while (it.hasNext())
      {
        Entry<String, String> entry = it.next();

        String key = entry.getKey();
        String value = entry.getValue();

        if (key.contains("."))
        {
          int index = key.lastIndexOf(".");

          if (index != -1)
          {
            String language = key.substring(0, index);
            String subKey = key.substring(index + 1);

            if (!object.has(language))
            {
              object.put(language, new JSONObject());
            }

            JSONObject subMap = object.getJSONObject(language);
            subMap.put(subKey, value);
          }
        }
        else
        {
          object.put(key, value);
        }
      }

      return object.toString();
    }
    catch (JSONException e)
    {
      throw new ProgrammingErrorException("Error occured creating the localized JSON map", e);
    }
  }
}

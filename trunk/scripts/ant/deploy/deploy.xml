<?xml version="1.0" encoding="UTF-8"?>
<project name="test" default="deploy">

	<!-- =================================================================== -->
	<!-- Set up our properties                                               -->
	<!-- =================================================================== -->

	<property name="profile.root" value="../../../profiles" />
	<property name="system.password" value="mdsstest2" />
	<taskdef name="tfproperties" classname="com.terraframe.mojo.ant.TFProperties" classpath="${profile.root};tfprops.jar" />
	<tfproperties root="${profile.root}" />

	<!-- execution path -->
	<path id="framework.classpath">
		<fileset dir="${local.lib}">
			<include name="**/*.jar" />
		</fileset>
		<pathelement location="${profile.root}" />
		<pathelement path="${java.ext.dirs}/sunjce_provider.jar" />
		<pathelement location="${local.bin}" />
		<pathelement location="${client.bin}" />
		<pathelement location="${server.bin}" />
		<pathelement location="${common.bin}" />
	</path>

	<property name="domain.location" value="${local.root}/doc/entomology.xml" />
	<property name="xsd.location" value="${local.root}/profiles/datatype_gis.xsd" />
	<property name="version.dir" value="${local.root}/doc/" />
	<property name="version.xsd" value="/version_gis.xsd" />
	<property name="geo_data_db" value="mozambique" />

	<!-- =================================================================== -->
	<!-- Define tomcat tasks                                                 -->
	<!-- =================================================================== -->

	<taskdef name="reload" classname="org.apache.catalina.ant.ReloadTask" classpath="${server.lib}/catalina-ant.jar" />

	<taskdef name="start" classname="org.apache.catalina.ant.StartTask" classpath="${server.lib}/catalina-ant.jar" />

	<taskdef name="stop" classname="org.apache.catalina.ant.StopTask" classpath="${server.lib}/catalina-ant.jar" />

	<target name="reload_tomcat_webapp" description="Calls tomcat's manager to reload the webapp">
		<reload url="${deploy.manager.url}" username="${deploy.username}" password="${deploy.password}" path="/${deploy.appname}" />
		<echo message="The Tomcat webapp '${deploy.appname}' has been stopped" />
	</target>

	<!--If this is the first time this project is built, these tasks will not run-->
	<available file="${deploy.path}" type="dir" property="deploy_path_exists" />
	<target name="stop_tomcat_webapp" description="Calls tomcat's manager to stop the webapp" if="deploy_path_exists">
		<stop url="${deploy.manager.url}" username="${deploy.username}" password="${deploy.password}" path="/${deploy.appname}" />
		<echo message="The Tomcat webapp '${deploy.appname}' has been stopped" />
	</target>

	<target name="start_tomcat_webapp" description="Calls tomcat's manager to start the webapp" if="deploy_path_exists">
		<start url="${deploy.manager.url}" username="${deploy.username}" password="${deploy.password}" path="/${deploy.appname}" />
		<echo message="The Tomcat webapp '${deploy.appname}' has been started." />
	</target>

	<!-- Add in AspectJ task definitions -->
	<taskdef resource="org/aspectj/tools/ant/taskdefs/aspectjTaskdefs.properties">
		<classpath>
			<fileset dir="${local.lib}">
				<include name="**/*.jar" />
			</fileset>
		</classpath>
	</taskdef>

	<!-- =================================================================== -->
	<!-- Rebuild the environment                                             -->
	<!-- =================================================================== -->

	<target name="get_root_login" description="Checks for root username and prompts for it if not found." unless="root.user">
		<input message="Root Username:" addproperty="root.user" />
	</target>

	<target name="get_root_password" description="Checks for root password and prompts for it if not found." unless="root.pass">
		<input message="Root Password:" addproperty="root.pass" />
	</target>

	<target name="get_root_database" description="Checks for root database and prompts for it if not found." unless="root.db">
		<input message="Root Database:" addproperty="root.db" />
	</target>

	<target name="rebuild_db" description="Rebuilds the metadata" depends="get_root_login,get_root_password,get_root_database">
		<echo message="Setting up users and metadata on database!!!!!" />
		<java classname="com.terraframe.mojo.dataaccess.Installer" failonerror="true">
			<arg value="${root.user}" />
			<arg value="${root.pass}" />
			<arg value="${root.db}" />
			<arg file="${local.root}/scripts/metadata/schema.xsd" />
			<arg file="${local.root}/scripts/metadata/metadata.xml" />
			<arg file="${local.root}/scripts/metadata/gismetadata.xml" />
			<classpath>
				<path refid="framework.classpath" />
			</classpath>
		</java>
	</target>

	<target name="clean_generated" description="Removes all generated classes and directories">
		<!-- we don't want to fail on error because the dirs may not exist if this is a fresh install -->
		<delete failonerror="false" includeemptydirs="true">
			<fileset dir="${client.src}" includes="**/*" />
		</delete>
		<echo message="Cleaned generated directory [${client.src}]" />
		<delete failonerror="false" includeemptydirs="true">
			<fileset dir="${common.src}">
				<include name="**/*" />
				<!-- exclude name="xml/exceptions.xsd"/ -->
			</fileset>
		</delete>
		<echo message="Cleaned generated directory [${common.src}]" />
		<delete failonerror="false" includeemptydirs="true">
			<fileset dir="${server.src}" includes="**/*" />
		</delete>
		<echo message="Cleaned generated directory [${server.src}]" />
		<copy file="${profile.root}/exceptions.xsd" tofile="${common.src}/xml/exceptions.xsd" />
	</target>

	<target name="delete_generated_base" description="Removes all generated BASE classes and directories">
		<!-- we don't want to fail on error because the dirs may not exist if this is a fresh install -->
		<delete failonerror="false" includeemptydirs="true">
			<fileset dir="${client.src}/base" includes="**/*" />
			<fileset dir="${client.src}/bin" includes="**/*" />
		</delete>
		<delete failonerror="false" includeemptydirs="true">
			<fileset dir="${common.src}/base" includes="**/*" />
			<fileset dir="${common.src}/bin" includes="**/*" />
		</delete>
		<delete failonerror="false" includeemptydirs="true">
			<fileset dir="${server.src}/base" includes="**/*" />
			<fileset dir="${server.src}/bin" includes="**/*" />
		</delete>
		<echo message="Cleaned generated base directories" />
	</target>

	<target name="compile_generated">
		<javac destdir="${local.bin}" srcdir="${local.src}" debug="true">
			<classpath refid="framework.classpath" />
		</javac>
		<javac destdir="${common.bin}" srcdir="${common.src}" debug="true">
			<classpath refid="framework.classpath" />
		</javac>
		<javac destdir="${client.bin}" srcdir="${client.src}" debug="true">
			<classpath>
				<path refid="framework.classpath" />
				<pathelement location="${common.bin}" />
			</classpath>
		</javac>
		<javac destdir="${server.bin}" srcdir="${server.src}" debug="true">
			<classpath>
				<path refid="framework.classpath" />
				<pathelement location="${common.bin}" />
			</classpath>
		</javac>
		<javac destdir="${client.bin}" srcdir="${client.src}" debug="true">
			<classpath>
				<path refid="framework.classpath" />
				<pathelement location="${common.bin}" />
			</classpath>
		</javac>
	</target>

	<target name="update_domain_model" depends="delete_generated_base">
		<!-- Import the domain model -->
		<java classname="ImportModel" failonerror="true">
			<arg file="${domain.location}" />
			<arg file="${xsd.location}" />
			<classpath>
				<path refid="framework.classpath" />
			</classpath>
		</java>
	</target>

	<target name="update_db_source_and_classes">
		<!-- Update the database with the new sources and classes -->
		<java classname="com.terraframe.mojo.util.UpdateDatabaseSourceAndClasses" failonerror="true">
			<classpath>
				<path refid="framework.classpath" />
			</classpath>
		</java>
	</target>

	<target name="update_deploy_source">
		<!-- Update the database with the new sources and classes -->
		<java classname="com.terraframe.mojo.dataaccess.io.dataDefinition.DeployedMetadataUpdater" failonerror="true">
			<arg value="${export.package}" />
			<classpath>
				<path refid="framework.classpath" />
			</classpath>
		</java>
	</target>

	<target name="deploy" depends="deploy_presentation_files,deploy_application_files,deploy_web_xml">
		<!-- Flatten a profile and stick it on tomcat. -->
		<java classname="com.terraframe.mojo.ant.ProfileFlattener" fork="false" failonerror="true">
			<arg value="${deploy.profile}" />
			<arg value="$$${deploy.appname}_tmp" />
			<classpath>
				<fileset file="${local.lib}/terraframe.jar" />
				<pathelement location="${profile.root}" />
			</classpath>
		</java>

		<!-- Copy the flattened profile -->
		<copy todir="${deploy.bin}" overwrite="true">
			<fileset dir="${profile.root}/$$${deploy.appname}_tmp">
				<include name="**/*" />
			</fileset>
			<fileset dir="${profile.root}">
				<exclude name="master.properties" />
				<include name="*.*" />
			</fileset>
		</copy>

		<!-- Overwrite local.properties with the JEE defaults -->
		<copy tofile="${deploy.bin}/local.properties" file="JEElocal.properties" overwrite="true" />

		<!-- Finally, delete the temp directory -->
		<delete dir="${profile.root}/$$${deploy.appname}_tmp" />

	</target>

	<target name="deploy_web_xml" description="constructs the web.xml file for the given application">

		<!-- Delete the old web.xml file -->
		<delete failonerror="false">
			<fileset dir="${deploy.webinf}">
				<include name="**/web.xml" />
			</fileset>
		</delete>

		<!-- Create the new web.xml file -->
		<concat destfile="${deploy.webinf}/web.xml">
			<fileset dir="${local.ant}">
				<include name="web_begin.xml" />
			</fileset>
			<fileset dir="${local.ant}">
				<include name="web_application_settings.xml" />
			</fileset>
			<fileset dir="${local.ant}">
				<include name="web_end.xml" />
			</fileset>
		</concat>

	</target>

	<target name="deploy_presentation_files">

		<!-- deploy application files (e.g., js, html, and jsp) -->
		<copy toDir="${deploy.path}" overwrite="true">
			<fileset dir="${webapp.root}">
				<include name="**/*.jsp" />
				<include name="**/*.html" />
				<include name="js/**" />
				<include name="**/*.css" />
				<include name="reports/**" />
				<include name="imgs/**" />
			</fileset>
		</copy>
	</target>

	<!-- deploy application specific files -->
	<target name="deploy_application_files">

		<!-- create WEB-INF skeleton structure -->
		<mkdir dir="${deploy.webinf}" />
		<mkdir dir="${deploy.webinf}/tlds" />
		<mkdir dir="${deploy.bin}" />
		<mkdir dir="${deploy.lib}" />

		<copy todir="${deploy.webinf}/tlds" overwrite="true" verbose="true">
			<fileset dir="${webapp.root}/WEB-INF/tlds" />
		</copy>

		<copy todir="${deploy.webinf}/platform" overwrite="true" verbose="true">
			<fileset dir="${webapp.root}/WEB-INF/platform" />
		</copy>

		<!-- create the META-INF dir -->
		<copy toDir="${deploy.path}/META-INF" overwrite="true">
			<fileset dir="${webapp.root}/META-INF" />
		</copy>

		<!-- deploy all application jars -->
		<copy toDir="${deploy.lib}" overwrite="true" flatten="true">
			<fileset dir="${local.lib}">
				<include name="**/*.jar" />
				<exclude name="**/servlet-api-*.jar" />
				<exclude name="**/jsp-api.jar" />
			</fileset>
		</copy>

		<antcall target="compile_generated">
		</antcall>
		<copy todir="${deploy.bin}">
			<fileset dir="${server.bin}" includes="**/*.class" />
			<fileset dir="${common.bin}" includes="**/*.class" />
			<fileset dir="${client.bin}" includes="**/*.class" />
		</copy>

		<!-- compile and jar the application library (e.g., servlet filters) -->
		<javac srcdir="${local.src}" destDir="${deploy.bin}" debug="true" source="1.5" target="1.5">
			<compilerarg value="-Xlint"/>
			<classpath>
				<path refid="framework.classpath" />
				<pathelement location="${client.bin}" />
				<pathelement location="${common.bin}" />
				<pathelement location="${server.bin}" />
			</classpath>
		</javac>

		<!-- These files are needed for compilation, but should not exist in the deploy -->
		<delete file="${deploy.bin}/dss/vector/solutions/global/CredentialsSingleton.class" />
		<delete file="${deploy.bin}/dss/vector/solutions/global/CredentialsSingleton$Singleton.class" />
		<delete file="${deploy.bin}/dss/vector/solutions/geoserver/GeoServerRequestFilter.class" />

	</target>

	<target name="export_credentials_singleton">
		<jar destfile="${deploy.root}/lib/credentialsSingleton.jar" basedir="${local.bin}" compress="true">
			<include name="dss/vector/solutions/global/CredentialsSingleton.class" />
			<include name="dss/vector/solutions/global/CredentialsSingleton$Singleton.class" />
		</jar>
	</target>

	<target name="export_tomcat_classloader" description="Exports the Tomcat webapp classloader">
		<copy file="terraframeTomcatLoader.jar" tofile="${deploy.classloader.jar}" />
	</target>

	<target name="prepare_web_service" description="Publishes web services to Apache Axis">

		<!-- get the path of the axis lib -->
		<path id="axis.classpath">
			<fileset dir="${server.lib}">
				<include name="**/*.jar" />
			</fileset>
			<fileset dir="${common.lib}">
				<include name="**/*.jar" />
			</fileset>
		</path>

		<!-- define the core services -->
		<java classname="com.terraframe.mojo.facade.wsdd.WebServiceDeployer" fork="true" failonerror="true">
			<classpath>
				<path refid="framework.classpath" />
				<path refid="axis.classpath" />
			</classpath>
		</java>
	</target>


	<!-- =================================================================== -->
	<!-- Set the schema to the given version number                          -->
	<!-- =================================================================== -->

	<target name="get_version_number" description="Checks for root database and prompts for it if not found." unless="version.number">
		<property name="${version.number}" value="0" />
	</target>

	<target name="import_most_recent" description="Updates the domain model to the most recent schema" depends="get_version_number">
		<echo message="Update domain to the most recent schema" />
		<java classname="com.terraframe.mojo.dataaccess.io.Versioning" failonerror="true">
			<arg value="${version.dir}/" />
			<arg value="${version.xsd}"/>
			<classpath>
				<path refid="framework.classpath" />
			</classpath>
		</java>
	</target>

	<target name="create_new_domain_model" description="Creates a new time stamped domain model">
		<echo message="Create a time stamped schema" />
		<java classname="com.terraframe.mojo.dataaccess.io.CreateDomainModel" failonerror="true">
			<arg value="${version.dir}/" />
			<classpath>
				<path refid="framework.classpath" />
			</classpath>
		</java>
	</target>

	<target name="push_source" depends="">
		<java classname="dss.vector.solutions.MdssDmu" fork="true" failonerror="true" dir="." timeout="4000000" taskname="pushSource">
			<jvmarg value="-Xmx1024m" />
			<classpath>
				<path refid="framework.classpath" />
			</classpath>
			<arg value="${system.password}" />
			<arg value="dss.vector.solutions%" />
		</java>
	</target>

	<!-- =================================================================== -->
	<!-- Import the geo data into the db                             -->
	<!-- =================================================================== -->
	<target name="import_geodata" depends="" description="imports a db of geodata into the db">
		<java classname="dss.vector.solutions.util.GeoEntityImporter" fork="true" failonerror="true" dir="." timeout="4000000" taskname="ImportGeodata">
			<jvmarg value="-Xmx1024m" />
			<classpath>
				<path refid="framework.classpath" />
			</classpath>
			<arg value="${root.user}" />
			<arg value="${root.pass}" />
			<arg value="${geo_data_db}" />
		</java>
	</target>

</project>

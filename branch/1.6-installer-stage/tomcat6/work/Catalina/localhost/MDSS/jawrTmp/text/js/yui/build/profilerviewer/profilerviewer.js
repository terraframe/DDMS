
(function(){YAHOO.widget.ProfilerViewer=function(el,attr){attr=attr||{};if(arguments.length==1&&!YAHOO.lang.isString(el)&&!el.nodeName){attr=el;el=attr.element||null;}
if(!el&&!attr.element){el=this._createProfilerViewerElement();}
YAHOO.widget.ProfilerViewer.superclass.constructor.call(this,el,attr);this._init();};YAHOO.extend(YAHOO.widget.ProfilerViewer,YAHOO.util.Element);YAHOO.lang.augmentObject(YAHOO.widget.ProfilerViewer,{CLASS:'yui-pv',CLASS_DASHBOARD:'yui-pv-dashboard',CLASS_REFRESH:'yui-pv-refresh',CLASS_BUSY:'yui-pv-busy',CLASS_CHART_CONTAINER:'yui-pv-chartcontainer',CLASS_CHART:'yui-pv-chart',CLASS_CHART_LEGEND:'yui-pv-chartlegend',CLASS_TABLE:'yui-pv-table',STRINGS:{title:"YUI Profiler (beta)",buttons:{viewprofiler:"View Profiler Data",hideprofiler:"Hide Profiler Report",showchart:"Show Chart",hidechart:"Hide Chart",refreshdata:"Refresh Data"},colHeads:{fn:["Function/Method",null],calls:["Calls",40],avg:["Average",80],min:["Shortest",70],max:["Longest",70],total:["Total Time",70],pct:["Percent",70]},millisecondsAbbrev:"ms",initMessage:"initialiazing chart...",installFlashMessage:"Unable to load Flash content. The YUI Charts Control requires Flash Player 9.0.45 or higher. You can download the latest version of Flash Player from the <a href='http://www.adobe.com/go/getflashplayer'>Adobe Flash Player Download Center</a>."},timeAxisLabelFunction:function(n){var a=(n===Math.floor(n))?n:(Math.round(n*1000))/1000;return(a+" "+YAHOO.widget.ProfilerViewer.STRINGS.millisecondsAbbrev);},percentAxisLabelFunction:function(n){var a=(n===Math.floor(n))?n:(Math.round(n*100))/100;return(a+"%");}},true);var Dom=YAHOO.util.Dom;var Event=YAHOO.util.Event;var Profiler=YAHOO.tool.Profiler;var PV=YAHOO.widget.ProfilerViewer;var proto=PV.prototype;proto.refreshData=function(){this.fireEvent("dataRefreshEvent");};proto.getHeadEl=function(){return(this._headEl)?Dom.get(this._headEl):false;};proto.getBodyEl=function(){return(this._bodyEl)?Dom.get(this._bodyEl):false;};proto.getChartEl=function(){return(this._chartEl)?Dom.get(this._chartEl):false;};proto.getTableEl=function(){return(this._tableEl)?Dom.get(this._tableEl):false;};proto.getDataTable=function(){return this._dataTable;};proto.getChart=function(){return this._chart;};proto._rendered=false;proto._headEl=null;proto._bodyEl=null;proto._toggleVisibleEl=null;proto._busyEl=null;proto._busy=false;proto._tableEl=null;proto._dataTable=null;proto._chartEl=null;proto._chartLegendEl=null;proto._chartElHeight=250;proto._chart=null;proto._chartInitialized=false;proto._init=function(){this.createEvent("dataRefreshEvent");this.createEvent("renderEvent");this.on("dataRefreshEvent",this._refreshDataTable,this,true);this._initLauncherDOM();if(this.get("showChart")){this.on("sortedByChange",this._refreshChart);}};proto._createProfilerViewerElement=function(){var el=document.createElement("div");document.body.insertBefore(el,document.body.firstChild);Dom.addClass(el,this.SKIN_CLASS);Dom.addClass(el,PV.CLASS);return el;};proto.toString=function(){return"ProfilerViewer "+(this.get('id')||this.get('tagName'));};proto._toggleVisible=function(){var newVis=(this.get("visible"))?false:true;this.set("visible",newVis);};proto._show=function(){if(!this._busy){this._setBusyState(true);if(!this._rendered){var loader=new YAHOO.util.YUILoader();if(this.get("base")){loader.base=this.get("base");}
var modules=["datatable"];if(this.get("showChart")){modules.push("charts");}
loader.insert({require:modules,onSuccess:function(){this._render();},scope:this});}else{var el=this.get("element");Dom.removeClass(el,"yui-pv-minimized");this._toggleVisibleEl.innerHTML=PV.STRINGS.buttons.hideprofiler;Dom.addClass(el,"yui-pv-null");Dom.removeClass(el,"yui-pv-null");this.refreshData();}}};proto._hide=function(){this._toggleVisibleEl.innerHTML=PV.STRINGS.buttons.viewprofiler;Dom.addClass(this.get("element"),"yui-pv-minimized");};proto._render=function(){Dom.removeClass(this.get("element"),"yui-pv-minimized");this._initViewerDOM();this._initDataTable();if(this.get("showChart")){this._initChartDOM();this._initChart();}
this._rendered=true;this._toggleVisibleEl.innerHTML=PV.STRINGS.buttons.hideprofiler;this.fireEvent("renderEvent");};proto._initLauncherDOM=function(){var el=this.get("element");Dom.addClass(el,PV.CLASS);Dom.addClass(el,"yui-pv-minimized");this._headEl=document.createElement("div");Dom.addClass(this._headEl,"hd");var s=PV.STRINGS.buttons;var b=(this.get("visible"))?s.hideprofiler:s.viewprofiler;this._toggleVisibleEl=this._createButton(b,this._headEl);this._refreshEl=this._createButton(s.refreshdata,this._headEl);Dom.addClass(this._refreshEl,PV.CLASS_REFRESH);this._busyEl=document.createElement("span");this._headEl.appendChild(this._busyEl);var title=document.createElement("h4");title.innerHTML=PV.STRINGS.title;this._headEl.appendChild(title);el.appendChild(this._headEl);Event.on(this._toggleVisibleEl,"click",this._toggleVisible,this,true);Event.on(this._refreshEl,"click",function(){if(!this._busy){this._setBusyState(true);this.fireEvent("dataRefreshEvent");}},this,true);};proto._initViewerDOM=function(){var el=this.get("element");this._bodyEl=document.createElement("div");Dom.addClass(this._bodyEl,"bd");this._tableEl=document.createElement("div");Dom.addClass(this._tableEl,PV.CLASS_TABLE);this._bodyEl.appendChild(this._tableEl);el.appendChild(this._bodyEl);};proto._initChartDOM=function(){this._chartContainer=document.createElement("div");Dom.addClass(this._chartContainer,PV.CLASS_CHART_CONTAINER);var chl=document.createElement("div");Dom.addClass(chl,PV.CLASS_CHART_LEGEND);var chw=document.createElement("div");this._chartLegendEl=document.createElement("dl");this._chartLegendEl.innerHTML="<dd>"+PV.STRINGS.initMessage+"</dd>";this._chartEl=document.createElement("div");Dom.addClass(this._chartEl,PV.CLASS_CHART);var msg=document.createElement("p");msg.innerHTML=PV.STRINGS.installFlashMessage;this._chartEl.appendChild(msg);this._chartContainer.appendChild(chl);chl.appendChild(chw);chw.appendChild(this._chartLegendEl);this._chartContainer.appendChild(this._chartEl);this._bodyEl.insertBefore(this._chartContainer,this._tableEl);};proto._createButton=function(label,parentEl,position){var b=document.createElement("a");b.innerHTML=b.title=label;if(parentEl){if(!position){parentEl.appendChild(b);}else{parentEl.insertBefore(b,parentEl.firstChild);}}
return b;};proto._setBusyState=function(b){if(b){Dom.addClass(this._busyEl,PV.CLASS_BUSY);this._busy=true;}else{Dom.removeClass(this._busyEl,PV.CLASS_BUSY);this._busy=false;}};proto._genSortFunction=function(key,dir){var by=key;var direction=dir;return function(a,b){if(direction==YAHOO.widget.DataTable.CLASS_ASC){return a[by]-b[by];}else{return((a[by]-b[by])*-1);}};};var _arraySum=function(arr){var ct=0;for(var i=0;i<arr.length;ct+=arr[i++]){}
return ct;};proto._getProfilerData=function(){var obj=Profiler.getFullReport();var arr=[];var totalTime=0;for(name in obj){if(YAHOO.lang.hasOwnProperty(obj,name)){var r=obj[name];var o={};o.fn=name;o.points=r.points.slice();o.calls=r.calls;o.min=r.min;o.max=r.max;o.avg=r.avg;o.total=_arraySum(o.points);o.points=r.points;var f=this.get("filter");if((!f)||(f(o))){arr.push(o);totalTime+=o.total;}}}
for(var i=0,j=arr.length;i<j;i++){arr[i].pct=(totalTime)?(arr[i].total*100)/totalTime:0;}
var sortedBy=this.get("sortedBy");var key=sortedBy.key;var dir=sortedBy.dir;arr.sort(this._genSortFunction(key,dir));return arr;};proto._initDataTable=function(){var self=this;this._dataSource=new YAHOO.util.DataSource(function(){return self._getProfilerData.call(self);},{responseType:YAHOO.util.DataSource.TYPE_JSARRAY,maxCacheEntries:0});var ds=this._dataSource;ds.responseSchema={fields:["fn","avg","calls","max","min","total","pct","points"]};var formatTimeValue=function(elCell,oRecord,oColumn,oData){var a=(oData===Math.floor(oData))?oData:(Math.round(oData*1000))/1000;elCell.innerHTML=a+" "+PV.STRINGS.millisecondsAbbrev;};var formatPercent=function(elCell,oRecord,oColumn,oData){var a=(oData===Math.floor(oData))?oData:(Math.round(oData*100))/100;elCell.innerHTML=a+"%";};var a=YAHOO.widget.DataTable.CLASS_ASC;var d=YAHOO.widget.DataTable.CLASS_DESC;var c=PV.STRINGS.colHeads;var f=formatTimeValue;var cols=[{key:"fn",sortable:true,label:c.fn[0],sortOptions:{defaultDir:a},resizeable:(YAHOO.util.DragDrop)?true:false,minWidth:c.fn[1]},{key:"calls",sortable:true,label:c.calls[0],sortOptions:{defaultDir:d},width:c.calls[1]},{key:"avg",sortable:true,label:c.avg[0],sortOptions:{defaultDir:d},formatter:f,width:c.avg[1]},{key:"min",sortable:true,label:c.min[0],sortOptions:{defaultDir:a},formatter:f,width:c.min[1]},{key:"max",sortable:true,label:c.max[0],sortOptions:{defaultDir:d},formatter:f,width:c.max[1]},{key:"total",sortable:true,label:c.total[0],sortOptions:{defaultDir:d},formatter:f,width:c.total[1]},{key:"pct",sortable:true,label:c.pct[0],sortOptions:{defaultDir:d},formatter:formatPercent,width:c.pct[1]}];this._dataTable=new YAHOO.widget.DataTable(this._tableEl,cols,ds,{scrollable:true,height:this.get("tableHeight"),initialRequest:null,sortedBy:{key:"total",dir:YAHOO.widget.DataTable.CLASS_DESC}});var dt=this._dataTable;dt.subscribe("sortedByChange",this._sortedByChange,this,true);dt.subscribe("renderEvent",this._dataTableRenderHandler,this,true);dt.subscribe("initEvent",this._dataTableRenderHandler,this,true);Event.on(this._tableEl.getElementsByTagName("th"),"click",this._thClickHandler,this,true);};proto._sortedByChange=function(o){if(o.newValue&&o.newValue.key){this.set("sortedBy",{key:o.newValue.key,dir:o.newValue.dir});}};proto._dataTableRenderHandler=function(o){this._setBusyState(false);};proto._thClickHandler=function(o){this._setBusyState(true);};proto._refreshDataTable=function(args){var dt=this._dataTable;dt.getDataSource().sendRequest("",dt.onDataReturnInitializeTable,dt);};proto._refreshChart=function(){switch(this.get("sortedBy").key){case"fn":this._chart.set("dataSource",this._chart.get("dataSource"));return;case"calls":this._chart.set("xAxis",this._chartAxisDefinitionPlain);break;case"pct":this._chart.set("xAxis",this._chartAxisDefinitionPercent);break;default:this._chart.set("xAxis",this._chartAxisDefinitionTime);break;}
this._drawChartLegend();this._chart.set("series",this._getSeriesDef(this.get("sortedBy").key));};proto._getChartData=function(){var records=this._dataTable.getRecordSet().getRecords(0,this.get("maxChartFunctions"));var arr=[];for(var i=0,j=records.length;i<j;i++){arr.push(records[i].getData());}
return arr;};proto._getSeriesDef=function(field){var sd=this.get("chartSeriesDefinitions")[field];var arr=[];for(var i=0,j=sd.group.length;i<j;i++){var c=this.get("chartSeriesDefinitions")[sd.group[i]];arr.push({displayName:c.displayName,xField:c.xField,style:{color:c.style.color,size:c.style.size}});}
return arr;};proto._initChart=function(){this._sizeChartCanvas();YAHOO.widget.Chart.SWFURL=this.get("swfUrl");var self=this;var ds=new YAHOO.util.DataSource(function(){return self._getChartData.call(self);},{responseType:YAHOO.util.DataSource.TYPE_JSARRAY,maxCacheEntries:0});ds.responseSchema={fields:["fn","avg","calls","max","min","total","pct"]};ds.subscribe('responseEvent',this._sizeChartCanvas,this,true);this._chartAxisDefinitionTime=new YAHOO.widget.NumericAxis();this._chartAxisDefinitionTime.labelFunction="YAHOO.widget.ProfilerViewer.timeAxisLabelFunction";this._chartAxisDefinitionPercent=new YAHOO.widget.NumericAxis();this._chartAxisDefinitionPercent.labelFunction="YAHOO.widget.ProfilerViewer.percentAxisLabelFunction";this._chartAxisDefinitionPlain=new YAHOO.widget.NumericAxis();this._chart=new YAHOO.widget.BarChart(this._chartEl,ds,{yField:"fn",series:this._getSeriesDef(this.get("sortedBy").key),style:this.get("chartStyle"),xAxis:this._chartAxisDefinitionTime});this._drawChartLegend();this._chartInitialized=true;this._dataTable.unsubscribe("initEvent",this._initChart,this);this._dataTable.subscribe("initEvent",this._refreshChart,this,true);};proto._drawChartLegend=function(){var seriesDefs=this.get("chartSeriesDefinitions");var currentDef=seriesDefs[this.get("sortedBy").key];var l=this._chartLegendEl;l.innerHTML="";for(var i=0,j=currentDef.group.length;i<j;i++){var c=seriesDefs[currentDef.group[i]];var dt=document.createElement("dt");Dom.setStyle(dt,"backgroundColor","#"+c.style.color);var dd=document.createElement("dd");dd.innerHTML=c.displayName;l.appendChild(dt);l.appendChild(dd);}};proto._sizeChartCanvas=function(o){var bars=(o)?o.response.length:this.get("maxChartFunctions");var s=(bars*36)+34;if(s!=parseInt(this._chartElHeight,10)){this._chartElHeight=s;Dom.setStyle(this._chartEl,"height",s+"px");}};proto.initAttributes=function(attr){YAHOO.widget.ProfilerViewer.superclass.initAttributes.call(this,attr);this.setAttributeConfig('base',{value:attr.base});this.setAttributeConfig('tableHeight',{value:attr.tableHeight||"15em",method:function(s){if(this._dataTable){this._dataTable.set("height",s);}}});this.setAttributeConfig('sortedBy',{value:attr.sortedBy||{key:"total",dir:"yui-dt-desc"}});this.setAttributeConfig('filter',{value:attr.filter||null,validator:YAHOO.lang.isFunction});this.setAttributeConfig('swfUrl',{value:attr.swfUrl||"http://yui.yahooapis.com/2.5.0/build/charts/assets/charts.swf"});this.setAttributeConfig('maxChartFunctions',{value:attr.maxChartFunctions||6,method:function(s){if(this._rendered){this._sizeChartCanvas();}},validator:YAHOO.lang.isNumber});this.setAttributeConfig('chartStyle',{value:attr.chartStyle||{font:{name:"Arial",color:0xeeee5c,size:12},background:{color:"6e6e63"}},method:function(){if(this._rendered&&this.get("showChart")){this._refreshChart();}}});this.setAttributeConfig('chartSeriesDefinitions',{value:attr.chartSeriesDefinitions||{total:{displayName:PV.STRINGS.colHeads.total[0],xField:"total",style:{color:"4d95dd",size:20},group:["total"]},calls:{displayName:PV.STRINGS.colHeads.calls[0],xField:"calls",style:{color:"edff9f",size:20},group:["calls"]},avg:{displayName:PV.STRINGS.colHeads.avg[0],xField:"avg",style:{color:"209daf",size:9},group:["avg","min","max"]},min:{displayName:PV.STRINGS.colHeads.min[0],xField:"min",style:{color:"b6ecf4",size:9},group:["avg","min","max"]},max:{displayName:PV.STRINGS.colHeads.max[0],xField:"max",style:{color:"29c7de",size:9},group:["avg","min","max"]},pct:{displayName:PV.STRINGS.colHeads.pct[0],xField:"pct",style:{color:"C96EDB",size:20},group:["pct"]}},method:function(){if(this._rendered&&this.get("showChart")){this._refreshChart();}}});this.setAttributeConfig('visible',{value:attr.visible||false,validator:YAHOO.lang.isBoolean,method:function(b){if(b){this._show();}else{if(this._rendered){this._hide();}}}});this.setAttributeConfig('showChart',{value:attr.showChart||true,validator:YAHOO.lang.isBoolean,writeOnce:true});YAHOO.widget.ProfilerViewer.superclass.initAttributes.call(this,attr);};})();YAHOO.register("profilerviewer",YAHOO.widget.ProfilerViewer,{version:"2.8.0r4",build:"2449"});
<?xml version="1.0" encoding="UTF-8"?>
<project name="patch" default="build">
	<property name="nsis.dir" value="C:/Program Files (x86)/NSIS" />
	<property name="project.dir" value="C:/svn/ddms" />
	<property name="svnant.dir" value="${project.dir}/trunk/lib/ant" />
	<property name="manager.dir" value="${project.dir}/standalone" />
	<property name="runway-patch.dir" value="${project.dir}/ddms-runway-patcher" />
	<property name="trunk.dir" value="${project.dir}/trunk" />
  <property name="trunk.root" location="${project.dir}/branch/1.6" />  
	<property name="doc.dir" value="${trunk.dir}/doc" />
	<property name="patches.dir" value="${trunk.dir}/patches" />
	<property name="geodata.db" value="mrc_blank" />	
	
	<!-- SVN task definition -->
	<typedef resource="org/tigris/subversion/svnant/svnantlib.xml">
		<classpath>
			<fileset dir="${svnant.dir}">
				<include name="*.jar" />
			</fileset>
		</classpath>
	</typedef>
	
	<svnSetting  
		svnkit="false"  
		javahl="false"
		username="cruisecontrol@terraframe.com" 
		password="Mr.Sparkle"
		failonerror="true"		
		id="svn.settings"/> 	

<!--	
	<target name="build" >
	<target name="build" depends="setup-files">
-->		
	<target name="build" depends="setup-files">
		<!-- Get revision info from svn -->
		<svn refid="svn.settings">
			<info target="${manager.dir}"  propPrefix="manager.info." />
			<info target="${runway-patch.dir}"  propPrefix="runway-patch.info." />			      
      <info target="${trunk.root}" propPrefix="svn.info." />
      <info target="${trunk.root}/doc/ontology/MOroots.xls" propPrefix="moroots.svn." />
      <info target="${trunk.root}/doc/menu/MenuItems.xls" propPrefix="menuitems.svn." />
      <info target="${trunk.root}/doc/localization" propPrefix="localization.svn." />
      <info target="${trunk.root}/profiles/Permissions.xls" propPrefix="permissions.svn." />      
			<info target="${project.dir}/installer-stage/birt" propPrefix="birt.svn." />	  
			<info target="${project.dir}/installer-stage/eclipse" propPrefix="eclipse.svn." />	        
			<info target="${project.dir}/installer-stage/tomcat/webapps" propPrefix="webapps.svn." />	 			
			<info target="${project.dir}/installer-stage/Java" propPrefix="java.svn." />
      <info target="${project.dir}/installer-stage/tomcat" propPrefix="tomcat.svn." />			
		</svn>
		
		<!-- Write revision info into all-in-one-patch.nsi -->
		<replaceregexp match="StrCpy \$ManagerVersion \d*" replace="StrCpy $ManagerVersion ${svn.info.lastRev}" file="./all-in-one-patch.nsi" byline="true" />
		<replaceregexp match="StrCpy \$RunwayVersion \d*" replace="StrCpy $RunwayVersion ${runway-patch.info.lastRev}" file="./all-in-one-patch.nsi" byline="true" />	
		<replaceregexp match="StrCpy \$PatchVersion \d*" replace="StrCpy $PatchVersion ${svn.info.lastRev}" file="./all-in-one-patch.nsi" byline="true" />
		<replaceregexp match="StrCpy \$RootsVersion \d*" replace="StrCpy $RootsVersion ${moroots.svn.lastRev}" file="./all-in-one-patch.nsi" byline="true" />
		<replaceregexp match="StrCpy \$MenuVersion \d*" replace="StrCpy $MenuVersion ${menuitems.svn.lastRev}" file="./all-in-one-patch.nsi" byline="true" />
		<replaceregexp match="StrCpy \$LocalizationVersion \d*" replace="StrCpy $LocalizationVersion ${localization.svn.lastRev}" file="./all-in-one-patch.nsi" byline="true" />
		<replaceregexp match="StrCpy \$PermissionsVersion \d*" replace="StrCpy $PermissionsVersion ${permissions.svn.lastRev}" file="./all-in-one-patch.nsi" byline="true" />			
		<replaceregexp match="StrCpy \$BirtVersion \d*" replace="StrCpy $BirtVersion ${birt.svn.lastRev}" file="./all-in-one-patch.nsi" byline="true" />	
		<replaceregexp match="StrCpy \$EclipseVersion \d*" replace="StrCpy $EclipseVersion ${eclipse.svn.lastRev}" file="./all-in-one-patch.nsi" byline="true" />	    
		<replaceregexp match="StrCpy \$WebappsVersion \d*" replace="StrCpy $WebappsVersion ${webapps.svn.lastRev}" file="./all-in-one-patch.nsi" byline="true" />	
		<replaceregexp match="StrCpy \$JavaVersion \d*" replace="StrCpy $JavaVersion ${java.svn.lastRev}" file="./all-in-one-patch.nsi" byline="true" />
		<replaceregexp match="StrCpy \$TomcatVersion \d*" replace="StrCpy $TomcatVersion ${tomcat.svn.lastRev}" file="./all-in-one-patch.nsi" byline="true" />

		<!-- Copy over an updated serverExceptions.property file -->
		<copy file="${project.dir}/trunk/profiles/serverExceptions.properties" todir="${manager.dir}/patch/profiles/" />

		<!-- Compile all-in-one-patch.nsi -->
		<exec executable="${nsis.dir}/makensis" dir="." failonerror="true" searchpath="true" logError="true">
			<arg line="all-in-one-patch.nsi" />
		</exec>
	</target>
	
	<target name="setup-files">
		<delete dir="${patches.dir}/webapp" includeemptydirs="true" />
		
		<!-- Compile -->
		<ant inheritAll="false" dir="${trunk.dir}/scripts/ant/deploy/" antfile="deploy.xml" target="compile_generated">
			<property name="profile.name" value="develop" />
			<property name="geodata.db" value="${geodata.db}" />
		</ant>
		
		<!-- Generate an up to date localization spread sheet -->		
<!--	
		
		<ant inheritAll="false" dir="${trunk.dir}/scripts/ant/deploy/" antfile="deploy.xml" target="import_localization_disease_defaults">
			<property name="profile.name" value="develop" />
			<property name="geodata.db" value="${geodata.db}" />
		</ant>
-->
		<!-- Get a copy of all web files -->
		
		<ant inheritAll="false" dir="${trunk.dir}/scripts/ant/deploy/" antfile="deploy.xml" target="deploy_all_files">
			<property name="profile.name" value="patch" />
			<property name="geodata.db" value="${geodata.db}" />
		</ant>	
		
		<!-- Copy in the appropriate geo universals xls -->
		<copy file="${doc.dir}/country/${geodata.db}-universals.xls" tofile="${patches.dir}/geo-universals.xls" />
		
		<!-- Create the local-develop.properties file -->
		<copy file="${patches.dir}/webapp/WEB-INF/classes/local.properties" tofile="${patches.dir}/webapp/WEB-INF/classes/local-develop.properties" />
		<replace file="${patches.dir}/webapp/WEB-INF/classes/local-develop.properties" token="environment=deploy" value="environment=develop" />
		
		<!-- We need to make sure we don't overwrite the domain/site master.  A better solution is to -->
		<!-- merge the old value into the new one.  For now, we just won't copy that file. -->
		<delete file="${patches.dir}/webapp/WEB-INF/classes/terraframe.properties" />
		<delete file="${patches.dir}/webapp/WEB-INF/classes/database.properties" />
		<delete file="${patches.dir}/webapp/WEB-INF/classes/common.properties" />
		<delete file="${patches.dir}/webapp/login.jsp" />
		<delete file="${patches.dir}/webapp/WEB-INF/originalVersion.jsp" />		
		
		<!-- Delete the flag, so that we don't overwrite it. That could be bad. -->
		<delete file="${patches.dir}/webapp/imgs/flags/current" />
		

		<!-- Delete the source and classes directory of the MERG survey form, so that we don't overwrite any custom fields. -->		
		<delete>
          <fileset dir="${patches.dir}/webapp/WEB-INF/classes/dss/vector/solutions/form/business" casesensitive="yes">
            <include name="**/*.class"/>
			<exclude name="**/*FormSurveyController*.class"/>
			<exclude name="**/*FormSurvey.class"/>
			<exclude name="**/*FormHousehold.class"/>						
		  </fileset>
		</delete>					
		<delete>
          <fileset dir="${patches.dir}/webapp/WEB-INF/source/server/stub/dss/vector/solutions/form/business" casesensitive="yes">
            <include name="**/*.java"/>
			<exclude name="**/*FormSurvey.java"/>
			<exclude name="**/*FormHousehold.java"/>			
		  </fileset>
		</delete>									
		<delete dir="${patches.dir}/webapp/WEB-INF/source/server/base/dss/vector/solutions/form/business" />		
		<delete>
          <fileset dir="${patches.dir}/webapp/WEB-INF/source/client/stub/dss/vector/solutions/form/business" casesensitive="yes">
            <include name="**/*.java"/>
			<exclude name="**/*FormSurveyController*.java"/>
		  </fileset>
		</delete>					
		<delete>
          <fileset dir="${patches.dir}/webapp/WEB-INF/source/client/base/dss/vector/solutions/form/business" casesensitive="yes">
            <include name="**/*.java"/>
			<exclude name="**/*FormSurveyController*.java"/>
		  </fileset>
		</delete>				
	</target>
</project>

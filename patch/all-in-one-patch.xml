<?xml version="1.0" encoding="UTF-8"?>
<project name="patch" default="build">
	<property name="nsis.dir" value="C:/Program Files (x86)/NSIS" />
	<property name="project.root" value="C:/git/DDMS" />
	<property name="manager.dir" value="${project.root}/standalone" />
	<property name="runway-patch.dir" value="${project.root}/ddms-runway-patcher" />
	<property name="trunk.dir" value="${project.root}/DDMS" />
  <property name="trunk.root" location="${project.root}/DDMS" />  
	<property name="doc.dir" value="${trunk.dir}/doc" />
	<property name="patches.dir" value="${trunk.dir}/patches" />
	<property name="geodata.db" value="mrc_blank" />	

<!--	
  ===============
    BUILD FLAGS
  ===============
  Copy and paste these depends into the target below to modify what you're building

	<target name="build" >
	<target name="build" depends="setup-files">
-->		
	<target name="build">
  
		<!-- Get revision info from git -->
    <exec executable="C:\Users\Administrator\AppData\Local\Programs\Python\Python35-32\python.exe" failonerror="true">
		  <arg line="C:\git\DDMS\build\ddms-revision-info.py"/>
		  <arg line="${project.root}/patch/all-in-one-patch.nsi" />
		  <arg line="${project.root}"/>
		</exec>
    
		<!-- Copy over an updated serverExceptions.property file -->
		<copy file="${trunk.dir}/profiles/serverExceptions.properties" todir="${manager.dir}/patch/profiles/" />

		<!-- Compile all-in-one-patch.nsi -->
		<exec executable="${nsis.dir}/makensis" dir="." failonerror="true" searchpath="true" logError="true">
			<arg line="all-in-one-patch.nsi" />
		</exec>
	</target>
	
	<target name="setup-files">
		<delete dir="${patches.dir}/webapp" includeemptydirs="true" />
		
		<!-- Compile -->
		<ant inheritAll="false" dir="${trunk.dir}/scripts/ant/deploy/" antfile="deploy.xml" target="compile_generated">
			<property name="profile.name" value="develop" />
			<property name="geodata.db" value="${geodata.db}" />
		</ant>
		
		<!-- Generate an up to date localization spread sheet -->		
<!--	
		
		<ant inheritAll="false" dir="${trunk.dir}/scripts/ant/deploy/" antfile="deploy.xml" target="import_localization_disease_defaults">
			<property name="profile.name" value="develop" />
			<property name="geodata.db" value="${geodata.db}" />
		</ant>
-->
		<!-- Get a copy of all web files -->
		
		<ant inheritAll="false" dir="${trunk.dir}/scripts/ant/deploy/" antfile="deploy.xml" target="deploy_all_files">
			<property name="profile.name" value="patch" />
			<property name="geodata.db" value="${geodata.db}" />
		</ant>	
		
		<!-- Copy in the appropriate geo universals xls -->
		<copy file="${doc.dir}/country/${geodata.db}-universals.xls" tofile="${patches.dir}/geo-universals.xls" />
		
		<!-- Create the local-develop.properties file -->
		<copy file="${patches.dir}/webapp/WEB-INF/classes/local.properties" tofile="${patches.dir}/webapp/WEB-INF/classes/local-develop.properties" />
		<replace file="${patches.dir}/webapp/WEB-INF/classes/local-develop.properties" token="environment=deploy" value="environment=develop" />
		
		<!-- We need to make sure we don't overwrite the domain/site master.  A better solution is to -->
		<!-- merge the old value into the new one.  For now, we just won't copy that file. -->
		<delete file="${patches.dir}/webapp/WEB-INF/classes/terraframe.properties" />
		<delete file="${patches.dir}/webapp/WEB-INF/classes/database.properties" />
		<delete file="${patches.dir}/webapp/WEB-INF/classes/common.properties" />
    <delete file="${patches.dir}/webapp/WEB-INF/classes/analytics.properties" />
		<!-- <delete file="${patches.dir}/webapp/login.jsp" /> -->
		<delete file="${patches.dir}/webapp/WEB-INF/originalVersion.jsp" />		
		
		<!-- Delete the flag, so that we don't overwrite it. That could be bad. -->
		<delete file="${patches.dir}/webapp/imgs/flags/current" />
		
    
    <!-- Since localization files are versioned now, we want to make sure that we delete these files otherwise they will overwrite localization on our target machine. -->
    <delete file="${patches.dir}/webapp/WEB-INF/classes/MDSS.properties" />
    <delete file="${patches.dir}/webapp/WEB-INF/classes/clientExceptions.properties" />
    <delete file="${patches.dir}/webapp/WEB-INF/classes/commonExceptions.properties" />
    <delete file="${patches.dir}/webapp/WEB-INF/classes/serverExceptions.properties" />
    

		<!-- Delete the source and classes directory of the MERG survey form, so that we don't overwrite any custom fields. -->		
		<delete>
          <fileset dir="${patches.dir}/webapp/WEB-INF/classes/dss/vector/solutions/form/business" casesensitive="yes">
            <include name="**/*.class"/>
			<exclude name="**/*FormSurveyController*.class"/>
			<exclude name="**/*FormSurvey.class"/>
			<exclude name="**/*FormHousehold.class"/>						
		  </fileset>
		</delete>					
		<delete>
          <fileset dir="${patches.dir}/webapp/WEB-INF/source/server/stub/dss/vector/solutions/form/business" casesensitive="yes">
            <include name="**/*.java"/>
			<exclude name="**/*FormSurvey.java"/>
			<exclude name="**/*FormHousehold.java"/>			
		  </fileset>
		</delete>									
		<delete dir="${patches.dir}/webapp/WEB-INF/source/server/base/dss/vector/solutions/form/business" />		
		<delete>
          <fileset dir="${patches.dir}/webapp/WEB-INF/source/client/stub/dss/vector/solutions/form/business" casesensitive="yes">
            <include name="**/*.java"/>
			<exclude name="**/*FormSurveyController*.java"/>
		  </fileset>
		</delete>					
		<delete>
          <fileset dir="${patches.dir}/webapp/WEB-INF/source/client/base/dss/vector/solutions/form/business" casesensitive="yes">
            <include name="**/*.java"/>
			<exclude name="**/*FormSurveyController*.java"/>
		  </fileset>
		</delete>				
	</target>
</project>
